package com.wiesfight.activities;

import main.com.wiesfight.dto.User;
import main.com.wiesfight.persistence.UserPersistence;

import com.google.gson.Gson;
import com.parse.Parse;
import com.parse.ParseException;
import com.parse.ParseInstallation;
import com.parse.ParseObject;
import com.parse.ParseQuery;
import com.wiesfight.R;
import com.wiesfight.R.layout;

import android.app.Activity;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.SharedPreferences.Editor;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.view.Menu;
import android.view.MenuItem;

public class StartActivity extends Activity {
	private static final String APPLICATION_ID = "62c4LxASRWuWfmkUiNhQQYzvBffHP3sNZVRDNS1t";
	private static final String CLIENT_KEY = "xhMJeAAqAVeGKwPnHoziBQzRMs1U5DTecIzq975g";
	private ParseInstallation currentInstallation;
	private User currentUser;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		this.initializeParse();
		if(this.userExistsForInstallation()) {
			this.goToMainActivity();
		}
		else {
			this.goToLoginActivity();
		}
		setContentView(R.layout.activity_start);
	}

	private void initializeParse() {
		Parse.initialize(this, APPLICATION_ID, CLIENT_KEY);
	    this.currentInstallation = ParseInstallation.getCurrentInstallation();
	    this.currentInstallation.saveInBackground();
	    ParseObject.registerSubclass(UserPersistence.class);
	}

    private boolean userExistsForInstallation() {
    	ParseQuery<UserPersistence> query = ParseQuery.getQuery(UserPersistence.class);
    	query.whereEqualTo("Installation", this.currentInstallation);
    	try {
    		UserPersistence user = query.getFirst();
    		this.currentUser = user.loadUserFromDB();
    		return user != null;
    	}
    	catch(ParseException e) {
    		return false;
    	}
	}
    
    private void goToMainActivity() {
    	SharedPreferences mPrefs = PreferenceManager.getDefaultSharedPreferences(this);
    	Editor prefsEditor = mPrefs.edit();
    	Intent intent = new Intent(this, MainActivity.class);
        Gson gs = new Gson();
        String jsonUser = gs.toJson(this.currentUser);
        prefsEditor.putString("currentUser", jsonUser);
        prefsEditor.commit();
        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
    	startActivity(intent);
    	finish();
    }
	
	private void goToLoginActivity() {
    	Intent intent = new Intent(this, LoginActivity.class);
    	intent.putExtra("currentInstallation", this.currentInstallation.getInstallationId());
        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
    	startActivity(intent);
    	finish();
	}
}
